version: 2.1
orbs:
  # https://github.com/cypress-io/circleci-orb
  cypress: cypress-io/cypress@1

executors:
  with-services:
    # to run MongoDB and Redis on CircleCI, follow the instructions
    # https://glebbahmutov.com/blog/testing-mongo-with-cypress/
    docker:
      # image used to install source code,
      # run our server and run Cypress tests
      - image: cypress/base:14.16.0
        environment:
          # for connecting to the Mongo and Redis services
          MONGODB: mongodb://root:rootPass1234@localhost:27017/
          SESSION_SECRET: SoMeSeCrEtStrInG

      # image used to run Mongo in a separate container
      - image: mongo:4.4.5
        environment:
          MONGO_INITDB_ROOT_USERNAME: root
          MONGO_INITDB_ROOT_PASSWORD: rootPass1234
      # image for running Redis
      - image: redis:alpine

workflows:
  build:
    jobs:
      # every testing job needs to install dependencies and Cypress
      - cypress/install:
          name: Install
          # to install dependencies, we do not need other services
          # so let's use the executor close to what the tests will use
          # https://github.com/cypress-io/circleci-orb/blob/master/docs/executors.md
          executor: cypress/base-14

      # run only the changed Cypress tests if any
      # and only if we are running in a pull request
      - cypress/run:
          name: Run changed Cypress tests
          executor: with-services
          requires:
            - Install
          post-checkout:
            - run:
                name: Stop if not a pull request
                command: |
                  if [ -z "$CIRCLE_PULL_REQUEST" ]; then
                    echo "Not a pull request, exiting..."
                    circleci-agent step halt
                  fi
            - run:
                name: Stop if no changed specs
                # also stop if there are too many changed specs
                command: |
                  git diff --name-only origin/main
                  # make sure to NOT fail if there are no changed specs
                  n=$(git diff --name-only origin/main | { grep cypress/integration || true; } | wc -l | tr -d ' ')
                  echo ""
                  echo "number of added or changed Cypress specs ${n}"
                  echo ""
                  if [ ${n} -lt 1 ]; then
                    echo "No Cypress specs changed, exiting..."
                    circleci-agent step halt
                  fi

                  if [ ${n} -gt 4 ]; then
                    echo "Too many Cypress specs changed, will run them all in the next job..."
                    circleci-agent step halt
                  fi

          # to "trick" the Orb into NOT installing again
          # (the dependencies were installed in the Install job)
          # we use the dummy "install-command"
          install-command: echo Already installed
          start: npm start
          wait-on: 'http://localhost:3000'
          no-workspace: true
          command: |
            git diff --name-only origin/main
            # by now we know there are changed Cypress specs
            # so we know grep command will not fail
            specs=$(git diff --name-only origin/main | grep cypress/integration | tr '\n' ',')
            echo ""
            echo "Changed and added Cypress specs"
            echo ${specs}
            echo ""

            # we have to form the Cypress run command ourselves
            npx cypress run --record --group "1. Changed specs" --spec ${specs}

      - cypress/run:
          name: Run all tests
          executor: with-services
          # only run all the tests if the changed (if any) specs passed
          requires:
            - Install
            - Run changed Cypress tests
          start: npm start
          wait-on: 'http://localhost:3000'
          record: true
          # split all specs across 4 machines
          # https://on.cypress.io/parallelization
          parallel: true
          parallelism: 4
          group: '2. All Circle Tests'
          no-workspace: true
