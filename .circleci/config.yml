version: 2.1
orbs:
  # https://github.com/cypress-io/circleci-orb
  cypress: cypress-io/cypress@1

executors:
  with-services:
    # to run MongoDB and Redis on CircleCI, follow the instructions
    # https://glebbahmutov.com/blog/testing-mongo-with-cypress/
    docker:
      # image used to install source code,
      # run our server and run Cypress tests
      - image: cypress/base:14.16.0
        environment:
          # for connecting to the Mongo and Redis services
          MONGODB: mongodb://root:rootPass1234@localhost:27017/
          SESSION_SECRET: SoMeSeCrEtStrInG

      # image used to run Mongo in a separate container
      - image: mongo:4.4.5
        environment:
          MONGO_INITDB_ROOT_USERNAME: root
          MONGO_INITDB_ROOT_PASSWORD: rootPass1234
      # image for running Redis
      - image: redis:alpine

workflows:
  build:
    jobs:
      # this job runs on commits to the "main" branch
      # https://circleci.com/docs/2.0/configuration-reference/#triggers
      - cypress/run:
          name: Run all tests
          filters:
            branches:
              only: main
          executor: with-services
          start: npm start
          wait-on: 'http://localhost:3000'
          record: true
          group: Circle Tests
          no-workspace: true
